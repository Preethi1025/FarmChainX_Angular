<div class="fixed inset-0 bg-black/40 flex items-center justify-center z-40 p-4">
  <div class="bg-white rounded-2xl shadow-xl w-full max-w-6xl max-h-[90vh] overflow-y-auto">

    <!-- HEADER -->
    <div class="flex justify-between items-center px-6 py-4 border-b">
      <div>
        <h2 class="text-lg font-semibold">Batch Management</h2>
        <p class="text-xs text-gray-500">
          Manage batches — split, merge, status, trace
        </p>
      </div>

      <div class="flex gap-2">
        <button
          (click)="processDailyHarvest()"
          [disabled]="processingHarvest || user?.role !== 'FARMER'"
          class="px-3 py-1.5 text-xs rounded bg-green-100 text-green-700">
          {{ processingHarvest ? 'Processing…' : 'Process Today’s Harvest' }}
        </button>

        <button
          (click)="fetchBatches()"
          class="px-3 py-1.5 text-xs border rounded">
          Refresh
        </button>

        <button
          (click)="close.emit()"
          class="px-3 py-1.5 text-xs bg-gray-800 text-white rounded">
          Close
        </button>
      </div>
    </div>

    <!-- ERROR -->
    <div *ngIf="error" class="m-4 p-3 bg-red-50 text-red-700 text-xs rounded">
      {{ error }}
    </div>

    <!-- TABLE -->
    <div class="p-6">
      <table class="w-full text-sm border">
        <thead class="bg-gray-50">
          <tr>
            <th>Batch</th>
            <th>Crop</th>
            <th>Qty</th>
            <th>Status</th>
            <th>Quality</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody>
          <ng-container *ngFor="let b of batches">

            <!-- ROW -->
            <tr class="border-b">
              <td>
                <button (click)="toggleExpand(b.batchId)">
                  {{ expandedBatchId === b.batchId ? '▼' : '▶' }}
                  {{ b.batchId }}
                </button>
              </td>
              <td>{{ b.cropType }}</td>
              <td>{{ b.totalQuantity }} kg</td>
              <td>
                <span class="px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs">
                  {{ b.status }}
                </span>
              </td>
              <td>
                {{ b.avgQualityScore != null ? (b.avgQualityScore + '%') : '-' }}
              </td>
              <td>
                <button (click)="toggleExpand(b.batchId)">Details</button>
              </td>
            </tr>

            <!-- EXPANDED -->
            <tr *ngIf="expandedBatchId === b.batchId">
              <td colspan="6" class="bg-gray-50 p-4">

                <div class="grid md:grid-cols-[2fr_1.3fr] gap-4">

                  <!-- LEFT -->
                  <div>
                    <p class="text-xs font-semibold mb-2">
                      Crops in this batch
                    </p>

                    <div *ngIf="loadingCrops[b.batchId]"
                         class="text-xs text-gray-500">
                      Loading crops…
                    </div>

                    <div *ngIf="!loadingCrops[b.batchId] && !batchCrops[b.batchId]?.length"
                         class="text-xs text-gray-400">
                      No crops found
                    </div>

                    <div *ngFor="let c of batchCrops[b.batchId]"
                         class="bg-white border rounded-lg p-2 mb-2">
                      <p class="text-xs font-medium">{{ c.cropName }}</p>
                      <p class="text-[11px] text-gray-500">
                        Qty: {{ c.quantity }} | Status: {{ c.status }}
                      </p>
                    </div>
                  </div>

                  <!-- RIGHT -->
                  <div class="space-y-3">

                    <!-- QR -->
                    <div class="bg-white border rounded-lg p-3">
                      <p class="text-xs font-semibold mb-1">Traceability QR</p>
                      <img class="w-24 h-24"
                        [src]="'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + getQrUrl(b)" />
                      <a class="block text-[11px] text-green-600 mt-1"
                         [href]="getQrUrl(b)"
                         target="_blank">
                        Open trace page
                      </a>
                    </div>

                    <!-- STATUS -->
                    <div class="bg-white border rounded-lg p-3">
                      <p class="text-xs font-semibold mb-1">Update Status</p>
                      <div class="flex gap-2">
                        <select
                          [(ngModel)]="statusUpdate[b.batchId]"
                          class="flex-1">
                          <option value="">Select</option>
                          <option *ngFor="let s of STATUS_OPTIONS" [value]="s">
                            {{ s }}
                          </option>
                        </select>

                        <button
                          (click)="applyStatusUpdate(b.batchId)"
                          [disabled]="loadingAction[b.batchId]">
                          {{ loadingAction[b.batchId] ? 'Saving…' : 'Save' }}
                        </button>
                      </div>
                    </div>

                    <!-- QUALITY -->
                    <div class="bg-white border rounded-lg p-3"
                         *ngIf="qualityUpdate[b.batchId]">
                      <p class="text-xs font-semibold mb-1">Quality Grade</p>
                      <div class="flex gap-2">
                        <select
                          [(ngModel)]="qualityUpdate[b.batchId].grade">
                          <option value="">Grade</option>
                          <option *ngFor="let q of QUALITY_OPTIONS" [value]="q">
                            {{ q }}
                          </option>
                        </select>

                        <input
                          type="number"
                          placeholder="Confidence"
                          [(ngModel)]="qualityUpdate[b.batchId].confidence" />

                        <button
                          (click)="applyQualityUpdate(b.batchId)"
                          [disabled]="loadingAction[b.batchId]">
                          {{ loadingAction[b.batchId] ? 'Saving…' : 'Save' }}
                        </button>
                      </div>
                    </div>

                    <!-- SPLIT / MERGE -->
                    <div class="bg-white border rounded-lg p-3">
                      <p class="text-xs font-semibold mb-1">Split / Merge</p>

                      <button
                        (click)="splitBatch(b.batchId)"
                        [disabled]="loadingAction[b.batchId]"
                        class="mr-2">
                        Split
                      </button>

                      <select [(ngModel)]="mergeTarget[b.batchId]">
                        <option value="">Merge into</option>
                        <option *ngFor="let x of batches" [value]="x.batchId">
                          {{ x.batchId }}
                        </option>
                      </select>

                      <button
                        (click)="mergeBatch(b.batchId)"
                        [disabled]="loadingAction[b.batchId]">
                        Merge
                      </button>
                    </div>

                    <!-- TRACE -->
                    <div class="bg-white border rounded-lg p-3">
                      <p class="text-xs font-semibold mb-1">Recent Trace</p>
                      <app-trace-preview [batchId]="b.batchId"></app-trace-preview>
                    </div>

                  </div>
                </div>

              </td>
            </tr>

          </ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>
