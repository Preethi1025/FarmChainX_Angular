<div class="min-h-screen bg-gray-50 p-6">

  <!-- HEADER -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold">ðŸŒ¾ Marketplace</h1>
      <p class="text-gray-600">
        Buy fresh, traceable products directly from farmers
      </p>
    </div>
  </div>

  <!-- FILTERS -->
  <div class="bg-white rounded-xl shadow p-4 mb-6 grid grid-cols-1 md:grid-cols-5 gap-4">
    <input type="text" placeholder="Search crop..." [(ngModel)]="search"
      class="border rounded px-3 py-2 md:col-span-2" />

    <input type="number" placeholder="Min â‚¹" [(ngModel)]="minPrice" class="border rounded px-3 py-2" />

    <input type="number" placeholder="Max â‚¹" [(ngModel)]="maxPrice" class="border rounded px-3 py-2" />

    <select [(ngModel)]="sortBy" class="border rounded px-3 py-2">
      <option value="">Sort</option>
      <option value="PRICE_ASC">Price â†‘</option>
      <option value="PRICE_DESC">Price â†“</option>
      <option value="QTY_ASC">Qty â†‘</option>
      <option value="QTY_DESC">Qty â†“</option>
    </select>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="text-center text-gray-500">
    Loading Marketplace...
  </div>

  <!-- PRODUCTS GRID -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

    <div *ngFor="let p of filteredProducts" class="bg-white rounded-xl shadow p-4 flex flex-col justify-between">

      <div class="relative h-40 mb-3">
        <img [src]="getImageUrl(p.cropImageUrl)" (error)="onImageError($event)"
          class="h-full w-full object-cover rounded-lg" />
      </div>

      <div>
        <h2 class="text-lg font-semibold">{{ p.cropName }}</h2>
        <p class="text-sm text-gray-500">Farmer: {{ p.farmerId }}</p>

        <p class="mt-1 text-xl font-bold text-green-700">
          â‚¹{{ p.price }} / kg
        </p>

        <p class="text-sm text-gray-500">
          Available: {{ p.quantity }} kg
        </p>

        <span class="inline-block mt-1 text-xs bg-green-50 text-green-700 px-2 py-0.5 rounded-full">
          Grade {{ p.qualityGrade }}
        </span>
      </div>

      <div class="mt-4 space-y-2">
        <button class="w-full border border-green-600 text-green-600 py-2 rounded" (click)="buyNow(p)">
          Buy Now
        </button>

        <button class="w-full text-sm text-gray-500 hover:text-green-700" (click)="openTrace(p.batchId)">
          ðŸŒ± Trace Origin
        </button>
      </div>
    </div>
  </div>
</div>

<div
  *ngIf="showTrace"
  class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-xl p-6 w-full max-w-md relative">

    <button
      class="absolute top-2 right-3 text-gray-500"
      (click)="closeTrace()"
    >
      âœ•
    </button>

    <!-- HEADER WITH REFRESH -->
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">
        Traceability
      </h3>

      <button
        type="button"
        title="Reload trace"
        (click)="reloadTrace()"
        class="flex items-center justify-center
               w-8 h-8 rounded-full
               border border-gray-300
               text-gray-600
               hover:bg-gray-100
               hover:text-gray-800
               transition"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="w-4 h-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 0014-5M19 5a9 9 0 00-14 5"
          />
        </svg>
      </button>
    </div>

    <app-trace-preview
      *ngIf="activeBatchId"
      [batchId]="activeBatchId"
      [attr.data-key]="traceRenderKey">
    </app-trace-preview>

  </div>
</div>

